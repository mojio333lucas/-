<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§è¨˜æ†¶æœ¬è‰æ¸¬é©— (é˜²ç•¶æ©Ÿç‰ˆ)</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f4f7f6; padding: 20px; text-align: center; margin: 0; }
        .container { background: white; max-width: 600px; margin: 0 auto; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h2 { color: #2e7d32; margin-bottom: 5px; }
        .sub-title { color: #666; font-size: 0.9rem; margin-bottom: 15px; }
        
        /* å¼±é»åˆ†ææ¢ */
        .memory-bar { display: flex; justify-content: space-around; background: #f1f8e9; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.8rem; color: #555; }
        .mem-item span { display: block; font-weight: bold; font-size: 1.1rem; color: #d32f2f; }

        .mode-bar { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #ccc; }
        .mode-btn { background: #e0e0e0; color: #333; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: 0.3s; }
        .mode-btn.active { background: #2e7d32; color: white; font-weight: bold; }

        .question-box { background: #e8f5e9; padding: 20px; border-radius: 10px; min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 20px; }
        .q-tag { background: #2e7d32; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; display: inline-block; }
        .q-text { font-size: 1.2rem; font-weight: bold; color: #1b5e20; line-height: 1.4; }
        
        .options { display: grid; gap: 10px; }
        .opt-btn { background: white; border: 2px solid #2e7d32; color: #2e7d32; padding: 12px; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .opt-btn:hover { background: #e8f5e9; }
        .opt-btn.correct { background: #4caf50; color: white; border-color: #4caf50; }
        .opt-btn.wrong { background: #f44336; color: white; border-color: #f44336; }
        
        .control-area { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .ctrl-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        #next-btn { background: #333; display: none; }
        #end-btn { background: #d32f2f; }
        #reset-mem-btn { background: #607d8b; font-size: 0.8rem; margin-top: 10px; padding: 5px 10px; color: white; border: none; border-radius: 5px; cursor: pointer; }

        #review-section { display: none; text-align: left; }
        .review-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .review-q { font-weight: bold; color: #333; margin-bottom: 5px; }
        .review-wrong { color: #d32f2f; font-size: 0.9rem; }
        .review-correct { color: #2e7d32; font-size: 0.9rem; font-weight: bold; }
        #restart-btn { width: 100%; margin-top: 20px; background: #2e7d32; padding: 15px; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
        
        /* éŒ¯èª¤è¨Šæ¯æç¤º */
        #error-msg { color: red; font-size: 0.8rem; display: none; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container" id="quiz-container">
    <h2>ğŸ§  æ™ºæ…§è¨˜æ†¶æœ¬è‰æ¸¬é©—</h2>
    <div class="sub-title">å¾—åˆ†: <span id="score">0</span> | é¡Œæ•¸: <span id="count">0</span></div>

    <div class="memory-bar">
        <div class="mem-item">ç§‘åæ¬Šé‡<span id="w-family">1</span></div>
        <div class="mem-item">ç”Ÿè—¥æ¬Šé‡<span id="w-drug">1</span></div>
        <div class="mem-item">å­¸åæ¬Šé‡<span id="w-sci">1</span></div>
        <div class="mem-item">å‚™è¨»æ¬Šé‡<span id="w-note">1</span></div>
    </div>
    <div id="error-msg">âš ï¸ ç„¡æ³•å­˜å–è¨˜æ†¶ï¼ˆç·šä¸Šé è¦½æ¨¡å¼ï¼‰ï¼Œæœ¬æ¬¡ç´€éŒ„ä¸æœƒä¿å­˜ã€‚</div>

    <div class="mode-bar">
        <button class="mode-btn active" onclick="setMode('mix', this)">ğŸ”€ æ™ºæ…§ç¶œåˆ</button>
        <button class="mode-btn" onclick="setMode('family', this)">ğŸŒ± ç§‘å</button>
        <button class="mode-btn" onclick="setMode('drug', this)">ğŸ’Š ç”Ÿè—¥å</button>
        <button class="mode-btn" onclick="setMode('sci', this)">ğŸ”¬ å­¸å</button>
        <button class="mode-btn" onclick="setMode('note', this)">ğŸ“ å‚™è¨»</button>
    </div>

    <div class="question-box">
        <div class="q-tag" id="q-tag">è¼‰å…¥ä¸­</div>
        <div class="q-text" id="question">æº–å‚™é–‹å§‹...</div>
    </div>

    <div class="options" id="options-area"></div>
    
    <div class="control-area">
        <button class="ctrl-btn" id="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â–¶</button>
        <button class="ctrl-btn" id="end-btn" onclick="endQuiz()">ğŸ“Š çµç®—</button>
    </div>
    
    <button id="reset-mem-btn" onclick="resetMemory()">â™»ï¸ æ¸…é™¤è¨˜æ†¶ (é‡ç½®å‡ºé¡Œæ©Ÿç‡)</button>
</div>

<div class="container" id="review-section">
    <h2>ğŸ“Š æ¸¬é©—çµç®—</h2>
    <p>æœ¬æ¬¡å¾—åˆ†ï¼š<span id="final-score" style="font-weight:bold; color:#2e7d32; font-size:1.5rem;"></span></p>
    <hr>
    <h3>âŒ æœ¬è¼ªéŒ¯é¡Œï¼š</h3>
    <div id="wrong-list"></div>
    <button id="restart-btn" onclick="restartQuiz()">ğŸ”„ é‡æ–°é–‹å§‹</button>
</div>

<script>
    const db = [
        {name:"çŸ¥æ¯", family:"Liliaceae", drug:"Anemarrhenae Rhizoma", sci:"Anemarrhena asphodeloides", note:"å« saponin (çš‚ç´ )"},
        {name:"ç”˜è‰", family:"Fabaceae", drug:"Glycyrrhizae Radix", sci:"Glycyrrhiza uralensis", note:"åœ‹è€ã€å« Glycyrrhizin"},
        {name:"é»ƒé€£", family:"Ranunculaceae", drug:"Coptidis Rhizoma", sci:"Coptis chinensis", note:"ç„¡ saponinã€æ ¹å¦‚é€£ç "},
        {name:"å·èŠ", family:"Apiaceae", drug:"Chuanxiong Rhizoma", sci:"Ligusticum chuanxiong", note:"ç„¡ Saponin"},
        {name:"ä½•é¦–çƒ", family:"Polygonaceae", drug:"Polygoni Multiflori Radix", sci:"Polygonum multiflorum", note:"é›²éŒ¦èŠ±ç´‹ã€é¦¬è‚çŸ³"},
        {name:"åœ°é»ƒ", family:"Scrophulariaceae", drug:"Rehmanniae Radix", sci:"Rehmannia glutinosa", note:"æ‡·æ…¶åœ°é»ƒ"},
        {name:"ç´°è¾›", family:"Aristolochiaceae", drug:"Asiasari Radix", sci:"Asarum sieboldii", note:"å–®ç”¨ä¸å¯éåŠéŒ¢"},
        {name:"ç™½é ­ç¿", family:"Ranunculaceae", drug:"Pulsatillae Radix", sci:"Pulsatilla chinensis", note:"å« saponin"},
        {name:"åœŸèŒ¯è‹“", family:"Liliaceae", drug:"Smilacis Glabrae Rhizoma", sci:"Smilax glabra", note:"å« saponinã€diosgenin"},
        {name:"èŒ¯è‹“", family:"Polyporaceae", drug:"Poria", sci:"Poria cocos", note:"èŒæ ¸ã€ä¹…æœå®‰é­‚"},
        {name:"é¦¬å‹ƒ", family:"Lycoperdaceae", drug:"Lasiosphaera", sci:"Calvatia gigantea", note:"é¦¬å±åŒ…"},
        {name:"ç‰›é»ƒ", family:"Bovidae", drug:"Bezoar Bovis", sci:"Bos taurus", note:"ç‰›è†½å›Šä¸­çš„çµçŸ³"},
        {name:"é‡‘éŠ€èŠ±", family:"Caprifoliaceae", drug:"Lonicerae Flos", sci:"Lonicera japonica", note:"å¿å†¬-å‡Œå†¬ä¸å‡‹"},
        {name:"æ´‹é‡‘èŠ±", family:"Solanaceae", drug:"Daturae Flos", sci:"Datura metel", note:"éº»æ²¸æ•£ã€Tropane alkaloids"},
        {name:"ç›Šæ¯è‰", family:"Lamiaceae", drug:"Leonuri Herba", sci:"Leonurus heterophyllus", note:"å……è”š(æœå¯¦)"},
        {name:"é­šè…¥è‰", family:"Saururaceae", drug:"Houttuyniae Herba", sci:"Houttuynia cordata", note:"è•ºèœ"},
        {name:"éº»é»ƒ", family:"Ephedraceae", drug:"Ephedrae Herba", sci:"Ephedra sinica", note:"å« Ephedrine(æ”¯æ°£ç®¡æ“´å¼µ)ã€è£¸å­æ¤ç‰©"},
        {name:"å…«è§’èŒ´é¦™", family:"Magnoliaceae", drug:"Anisi Stellati Fructus", sci:"Illicium verum", note:"å« Anetholeã€æ®ç™¼æ²¹"},
        {name:"æ±ºæ˜å­", family:"Fabaceae", drug:"Cassiae Semen", sci:"Cassia obtusifolia", note:"å­å½¢ä¼¼é¦¬è¹„"},
        {name:"è»Šå‰è‰", family:"Plantaginaceae", drug:"Plantaginis Herba", sci:"Plantago asiatica", note:"æœ‰ç€‰ä¸‹åŠŸç”¨"},
        {name:"èƒ¡æ¤’", family:"Piperaceae", drug:"Piperis Nigri Fructus", sci:"Piper nigrum", note:"èƒ¡æ¤’æœ"},
        {name:"è›‡åºŠå­", family:"Apiaceae", drug:"Cnidii Fructus", sci:"Cnidium monnieri", note:"æ²»é™½ç—¿ã€å®®å†·ä¸å­•ã€é€£é™½å…«åº§"},
        {name:"æª³æ¦”å­", family:"Arecaceae", drug:"Arecae Semen", sci:"Areca catechu", note:"å« Arecoline (æª³æ¦”é¹¼)"},
        {name:"æœä»²", family:"Eucommiaceae", drug:"Eucommiae Cortex", sci:"Eucommia ulmoides", note:"æ²’æœ‰ç€‰ä¸‹ã€æŠ˜æ–·æœ‰çµ²ã€ä¸€ç§‘ä¸€å±¬ã€é›Œé›„ç•°æ ªã€æ¨¹çš®å¼·å£¯è—¥"},
        {name:"åšæœ´", family:"Magnoliaceae", drug:"Magnoliae Cortex", sci:"Magnolia officinalis", note:"è—¥ç”¨è–çš®"},
        {name:"è‚‰æ¡‚", family:"Lauraceae", drug:"Cinnamomi Cortex", sci:"Cinnamomum cassia", note:"å« Cinnamaldehyde"},
        {name:"é»ƒæŸ", family:"Rutaceae", drug:"Phellodendri Cortex", sci:"Phellodendron amurense", note:"å« Berberineã€è‹¦å‘³å¥èƒƒã€è·Œæ‰“æå‚·è—¥"}
    ];

    let currentMode = 'mix';
    let score = 0, count = 0;
    let canAnswer = true;
    let wrongLog = [];
    let currentQData = {};
    let weights = { family: 1, drug: 1, sci: 1, note: 1 };

    // --- å®‰å…¨çš„è®€å–è¨˜æ†¶åŠŸèƒ½ ---
    function initWeights() {
        try {
            let saved = localStorage.getItem('quizWeights');
            if (saved) {
                weights = JSON.parse(saved);
            }
        } catch (e) {
            console.log("ç„¡æ³•è®€å– LocalStorage (å¯èƒ½æ˜¯ç·šä¸Šé è¦½æ¨¡å¼)");
            document.getElementById('error-msg').style.display = 'block';
        }
        updateWeightDisplay();
    }

    function saveWeights() {
        try {
            localStorage.setItem('quizWeights', JSON.stringify(weights));
        } catch (e) {
            // ç·šä¸Šé è¦½ç„¡æ³•å„²å­˜æ˜¯æ­£å¸¸çš„ï¼Œå¿½ç•¥éŒ¯èª¤å³å¯
        }
        updateWeightDisplay();
    }

    function updateWeightDisplay() {
        document.getElementById('w-family').innerText = weights.family;
        document.getElementById('w-drug').innerText = weights.drug;
        document.getElementById('w-sci').innerText = weights.sci;
        document.getElementById('w-note').innerText = weights.note;
    }

    function resetMemory() {
        if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç¿’è¨˜æ†¶å—ï¼Ÿæ‰€æœ‰å‡ºé¡Œæ©Ÿç‡å°‡æ¢å¾©è®Šå›å¹³å‡ã€‚")) {
            weights = { family: 1, drug: 1, sci: 1, note: 1 };
            saveWeights();
            alert("è¨˜æ†¶å·²æ¸…é™¤ï¼");
        }
    }

    function setMode(mode, btn) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        nextQuestion();
    }

    function getWeightedType() {
        let totalWeight = weights.family + weights.drug + weights.sci + weights.note;
        let randomNum = Math.random() * totalWeight;
        
        if (randomNum < weights.family) return 'family';
        randomNum -= weights.family;
        if (randomNum < weights.drug) return 'drug';
        randomNum -= weights.drug;
        if (randomNum < weights.sci) return 'sci';
        return 'note';
    }

    function nextQuestion() {
        canAnswer = true;
        document.getElementById('next-btn').style.display = 'none';
        
        const item = db[Math.floor(Math.random() * db.length)];
        let type = currentMode;

        if (type === 'mix') {
            type = getWeightedType();
        }

        let qText = "", tagText = "";
        let correctAns = item[type];
        if (!correctAns) { type = 'family'; correctAns = item.family; }

        switch(type) {
            case 'family': qText = `ã€${item.name}ã€‘ å±¬æ–¼å“ªä¸€ç§‘ï¼Ÿ`; tagText = "ğŸŒ± è€ƒç§‘å"; break;
            case 'drug':   qText = `ã€${item.name}ã€‘ çš„ç”Ÿè—¥å (Latin) æ˜¯ï¼Ÿ`; tagText = "ğŸ’Š è€ƒç”Ÿè—¥å"; break;
            case 'sci':    qText = `ã€${item.name}ã€‘ çš„å­¸å (Scientific) æ˜¯ï¼Ÿ`; tagText = "ğŸ”¬ è€ƒå­¸å"; break;
            case 'note':   qText = `é—œæ–¼ã€${item.name}ã€‘ çš„ç‰¹å¾µ/å‚™è¨»ï¼Œä½•è€…æ­£ç¢ºï¼Ÿ`; tagText = "ğŸ“ è€ƒç‰¹å¾µ"; break;
        }

        currentQData = { question: qText, correct: correctAns, type: type };
        
        document.getElementById('q-tag').innerText = tagText;
        document.getElementById('question').innerText = qText;

        let options = [correctAns];
        let safetyLoop = 0;
        while(options.length < 4 && safetyLoop < 50) {
            let randomItem = db[Math.floor(Math.random() * db.length)];
            let otherAns = randomItem[type];
            if(otherAns && !options.includes(otherAns)) options.push(otherAns);
            safetyLoop++;
        }
        options.sort(() => Math.random() - 0.5);

        const area = document.getElementById('options-area');
        area.innerHTML = "";
        options.forEach(opt => {
            let btn = document.createElement("button");
            btn.className = "opt-btn";
            btn.innerText = opt;
            btn.onclick = function() { checkAnswer(this, opt, correctAns); };
            area.appendChild(btn);
        });
    }

    function checkAnswer(btn, myAns, correctAns) {
        if(!canAnswer) return;
        canAnswer = false;
        count++;
        
        const allBtns = document.querySelectorAll('.opt-btn');
        if (myAns === correctAns) {
            btn.classList.add('correct');
            score++;
        } else {
            btn.classList.add('wrong');
            allBtns.forEach(b => { if(b.innerText === correctAns) b.classList.add('correct'); });
            
            wrongLog.push({ q: currentQData.question, wrong: myAns, right: correctAns });
            
            // å¢åŠ æ¬Šé‡ä¸¦å˜—è©¦å„²å­˜
            weights[currentQData.type] += 1;
            saveWeights();
        }
        
        document.getElementById('score').innerText = score;
        document.getElementById('count').innerText = count;
        document.getElementById('next-btn').style.display = 'inline-block';
    }

    function endQuiz() {
        document.getElementById('quiz-container').style.display = 'none';
        document.getElementById('review-section').style.display = 'block';
        document.getElementById('final-score').innerText = `${score} / ${count}`;
        
        const list = document.getElementById('wrong-list');
        list.innerHTML = "";
        if(wrongLog.length === 0) {
            list.innerHTML = "<p style='text-align:center; color:#2e7d32;'>ğŸ‰ å¤ªå¼·äº†ï¼é€™è¼ªå…¨å°ï¼</p>";
        } else {
            wrongLog.forEach((item, index) => {
                let div = document.createElement('div');
                div.className = 'review-item';
                div.innerHTML = `<div class="review-q">${index+1}. ${item.q}</div><div class="review-wrong">âŒ ä½ çš„å›ç­”ï¼š${item.wrong}</div><div class="review-correct">âœ… æ­£ç¢ºç­”æ¡ˆï¼š${item.right}</div>`;
                list.appendChild(div);
            });
        }
    }

    function restartQuiz() {
        score = 0; count = 0; wrongLog = [];
        document.getElementById('score').innerText = 0;
        document.getElementById('count').innerText = 0;
        document.getElementById('quiz-container').style.display = 'block';
        document.getElementById('review-section').style.display = 'none';
        nextQuestion();
    }

    // å•Ÿå‹•ç¨‹å¼ (å˜—è©¦è®€å–è¨˜æ†¶)
    initWeights();
    nextQuestion();
</script>
</body>
</html>
