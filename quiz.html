<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§è¨˜æ†¶æœ¬è‰æ¸¬é©— (ç¯„åœé¸æ“‡ç‰ˆ)</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f4f7f6; padding: 20px; text-align: center; margin: 0; }
        .container { background: white; max-width: 650px; margin: 0 auto; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2e7d32; margin-bottom: 5px; }
        .sub-title { color: #666; font-size: 0.9rem; margin-bottom: 15px; }

        /* --- è¨­å®šé é¢æ¨£å¼ --- */
        #setup-screen { display: block; text-align: left; }
        .setup-group { margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 10px; }
        .setup-title { font-weight: bold; color: #2e7d32; margin-bottom: 10px; display: block; }
        
        .range-btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .range-btn {
            padding: 8px 16px; border: 2px solid #2e7d32; background: white; color: #2e7d32;
            border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .range-btn.active { background: #2e7d32; color: white; }
        
        .custom-area { display: none; margin-top: 15px; max-height: 300px; overflow-y: auto; border-top: 1px dashed #ccc; padding-top: 10px; }
        .checkbox-item { display: inline-block; width: 48%; margin-bottom: 5px; font-size: 0.9rem; }
        .checkbox-item input { margin-right: 5px; }

        #start-btn { width: 100%; background: #ff9800; color: white; font-size: 1.2rem; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        #start-btn:hover { background: #e65100; }

        /* --- æ¸¬é©—é é¢æ¨£å¼ (é è¨­éš±è—) --- */
        #quiz-container { display: none; }
        
        .strategy-bar { background: #fff3e0; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ffe0b2; font-size: 0.95rem; text-align: center; }
        .strategy-bar label { margin: 0 10px; cursor: pointer; color: #e65100; font-weight: bold; }
        #pool-info { font-size: 0.85rem; color: #d84315; margin-top: 5px; font-weight: bold; }

        .memory-bar { display: flex; justify-content: space-around; background: #f1f8e9; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.8rem; color: #555; }
        .mem-item span { display: block; font-weight: bold; font-size: 1.1rem; color: #d32f2f; }

        .mode-bar { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #ccc; }
        .mode-btn { background: #e0e0e0; color: #333; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: 0.3s; }
        .mode-btn.active { background: #2e7d32; color: white; font-weight: bold; }

        .question-box { background: #e8f5e9; padding: 20px; border-radius: 10px; min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 20px; }
        .q-tag { background: #2e7d32; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; display: inline-block; }
        .q-text { font-size: 1.2rem; font-weight: bold; color: #1b5e20; line-height: 1.4; }
        
        .options { display: grid; gap: 10px; }
        .opt-btn { background: white; border: 2px solid #2e7d32; color: #2e7d32; padding: 12px; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .opt-btn:hover { background: #e8f5e9; }
        .opt-btn.correct { background: #4caf50; color: white; border-color: #4caf50; }
        .opt-btn.wrong { background: #f44336; color: white; border-color: #f44336; }
        
        .control-area { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .ctrl-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; margin: 5px; }
        #next-btn { background: #333; display: none; }
        #end-btn { background: #d32f2f; }
        
        /* çµç®—é é¢ */
        #review-section { display: none; text-align: left; }
        .review-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .review-q { font-weight: bold; color: #333; margin-bottom: 5px; }
        .review-wrong { color: #d32f2f; font-size: 0.9rem; }
        .review-correct { color: #2e7d32; font-size: 0.9rem; font-weight: bold; }
        
        #review-wrong-btn { width: 100%; margin-top: 20px; background: #ff9800; padding: 15px; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; display: none; }
        #restart-home-btn { width: 100%; margin-top: 10px; background: #607d8b; padding: 15px; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
        /* --- è¬ç”¨å°è¦½åˆ—æ¨£å¼ --- */
        .nav-header { 
            display: flex; 
            justify-content: space-between; /* è®“æŒ‰éˆ•åˆ†å±…å·¦å³å…©å´ */
            align-items: center;
            margin-bottom: 20px; 
            padding-bottom: 10px;
            border-bottom: 2px dashed #e0e0e0; /* åŠ ä¸€æ¢åˆ†éš”ç·šæ¯”è¼ƒå¥½çœ‹ */
        }
        .nav-btn { 
            text-decoration: none; 
            color: #555; 
            font-weight: bold; 
            font-size: 1rem; 
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px; /* åœ–ç¤ºè·Ÿæ–‡å­—çš„è·é›¢ */
            background-color: #f5f5f5; /* æ·¡æ·¡çš„ç°è‰²èƒŒæ™¯ */
        }
        .nav-btn:hover { 
            background-color: #e8f5e9; /* æ»‘é¼ ç§»éå»è®Šæ·¡ç¶ è‰² */
            color: #2e7d32; 
            transform: translateY(-2px); /* å¾®å¾®æµ®èµ·çš„æ•ˆæœ */
        }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-header">
        <a href="javascript:history.back()" class="nav-btn">â¬… ä¸Šä¸€é </a>
        
        <a href="index.html" class="nav-btn">ğŸ  å›é¦–é </a>
    </div>
    <h2>ğŸ§  æ™ºæ…§è¨˜æ†¶æœ¬è‰æ¸¬é©—</h2>
    
    <div id="setup-screen">
        <p class="sub-title">è«‹é¸æ“‡ä»Šå¤©è¦ç·´ç¿’çš„ç¯„åœï¼š</p>
        
        <div class="setup-group">
            <span class="setup-title">ğŸ“š å¿«é€Ÿé¸æ“‡ç¯„åœ</span>
            <div class="range-btn-group">
                <button class="range-btn active" onclick="selectRange('all', this)">å…¨éƒ¨è—¥æ</button>
                <button class="range-btn" onclick="selectRange('å¤§äºŒä¸Š', this)">å¤§äºŒä¸ŠæœŸæœ«</button>
                <button class="range-btn" onclick="selectRange('å¤§äºŒä¸‹', this)">å¤§äºŒä¸‹æœŸæœ«</button>
                <button class="range-btn" onclick="toggleCustom(this)">ğŸ“ è‡ªè¨‚å‹¾é¸</button>
            </div>
            
            <div id="custom-checkboxes" class="custom-area"></div>
        </div>

        <button id="start-btn" onclick="startQuiz()">ğŸš€ é–‹å§‹æ¸¬é©—</button>
    </div>

    <div id="quiz-container">
        <div class="sub-title">å¾—åˆ†: <span id="score">0</span> | é€²åº¦: <span id="count">0</span></div>

        <div class="strategy-bar">
            æ¨¡å¼ï¼š
            <label><input type="radio" name="strategy" value="once" checked onchange="updatePoolInfo()"> ğŸ åœ°æ¯¯å¼å…¨è·‘</label>
            <label><input type="radio" name="strategy" value="repeat" onchange="updatePoolInfo()"> ğŸ” ç„¡é™è¤‡ç¿’</label>
            <div id="pool-info"></div>
        </div>

        <div class="memory-bar">
            <div class="mem-item">ç§‘å<span id="w-family">1</span></div>
            <div class="mem-item">ç”Ÿè—¥<span id="w-drug">1</span></div>
            <div class="mem-item">å­¸å<span id="w-sci">1</span></div>
            <div class="mem-item">å‚™è¨»<span id="w-note">1</span></div>
        </div>

        <div class="mode-bar">
            <button class="mode-btn active" onclick="setMode('mix', this)">ğŸ”€ ç¶œåˆ</button>
            <button class="mode-btn" onclick="setMode('family', this)">ğŸŒ± ç§‘å</button>
            <button class="mode-btn" onclick="setMode('drug', this)">ğŸ’Š ç”Ÿè—¥</button>
            <button class="mode-btn" onclick="setMode('sci', this)">ğŸ”¬ å­¸å</button>
            <button class="mode-btn" onclick="setMode('note', this)">ğŸ“ å‚™è¨»</button>
        </div>

        <div class="question-box">
            <div class="q-tag" id="q-tag">æº–å‚™ä¸­</div>
            <div class="q-text" id="question"></div>
        </div>

        <div class="options" id="options-area"></div>
        
        <div class="control-area">
            <button class="ctrl-btn" id="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â–¶</button>
            <button class="ctrl-btn" id="end-btn" onclick="endQuiz()">ğŸ“Š çµç®—</button>
        </div>
    </div>

    <div id="review-section">
        <h2>ğŸ“Š æ¸¬é©—çµç®—</h2>
        <p>æœ¬æ¬¡å¾—åˆ†ï¼š<span id="final-score" style="font-weight:bold; color:#2e7d32; font-size:1.5rem;"></span></p>
        <button id="review-wrong-btn" onclick="startReviewWrong()">ğŸ¯ ç«‹å³è¤‡ç¿’éŒ¯é¡Œ</button>
        <hr>
        <h3>âŒ éŒ¯é¡Œç´€éŒ„ï¼š</h3>
        <div id="wrong-list"></div>
        <button id="restart-home-btn" onclick="goHome()">ğŸ  å›åˆ°é¦–é é‡æ–°é¸æ“‡</button>
    </div>
</div>

<script>
    // --- è³‡æ–™åº« (é‡é»ï¼šæ–°å¢ tags æ¬„ä½ä¾†å€åˆ†å­¸æœŸ) ---
    const db = [
        {tags:["å¤§äºŒä¸Š"], name:"çŸ¥æ¯", family:"Liliaceae", drug:"Anemarrhenae Rhizoma", sci:"Anemarrhena asphodeloides", note:"å« saponin (çš‚ç´ )"},
        {tags:["å¤§äºŒä¸Š"], name:"ç”˜è‰", family:"Fabaceae", drug:"Glycyrrhizae Radix", sci:"Glycyrrhiza uralensis", note:"åœ‹è€ã€å« Glycyrrhizin"},
        {tags:["å¤§äºŒä¸Š"], name:"é»ƒé€£", family:"Ranunculaceae", drug:"Coptidis Rhizoma", sci:"Coptis chinensis", note:"ç„¡ saponinã€æ ¹å¦‚é€£ç "},
        {tags:["å¤§äºŒä¸Š"], name:"å·èŠ", family:"Apiaceae", drug:"Chuanxiong Rhizoma", sci:"Ligusticum chuanxiong", note:"ç„¡ Saponin"},
        {tags:["å¤§äºŒä¸Š"], name:"ä½•é¦–çƒ", family:"Polygonaceae", drug:"Polygoni Multiflori Radix", sci:"Polygonum multiflorum", note:"é›²éŒ¦èŠ±ç´‹ã€é¦¬è‚çŸ³"},
        {tags:["å¤§äºŒä¸Š"], name:"åœ°é»ƒ", family:"Scrophulariaceae", drug:"Rehmanniae Radix", sci:"Rehmannia glutinosa", note:"æ‡·æ…¶åœ°é»ƒ"},
        {tags:["å¤§äºŒä¸Š"], name:"ç´°è¾›", family:"Aristolochiaceae", drug:"Asiasari Radix", sci:"Asarum sieboldii", note:"å–®ç”¨ä¸å¯éåŠéŒ¢"},
        {tags:["å¤§äºŒä¸Š"], name:"ç™½é ­ç¿", family:"Ranunculaceae", drug:"Pulsatillae Radix", sci:"Pulsatilla chinensis", note:"å« saponin"},
        {tags:["å¤§äºŒä¸Š"], name:"åœŸèŒ¯è‹“", family:"Liliaceae", drug:"Smilacis Glabrae Rhizoma", sci:"Smilax glabra", note:"å« saponinã€diosgenin"},
        {tags:["å¤§äºŒä¸Š"], name:"èŒ¯è‹“", family:"Polyporaceae", drug:"Poria", sci:"Poria cocos", note:"èŒæ ¸ã€ä¹…æœå®‰é­‚"},
        {tags:["å¤§äºŒä¸Š"], name:"é¦¬å‹ƒ", family:"Lycoperdaceae", drug:"Lasiosphaera", sci:"Calvatia gigantea", note:"é¦¬å±åŒ…"},
        {tags:["å¤§äºŒä¸Š"], name:"ç‰›é»ƒ", family:"Bovidae", drug:"Bezoar Bovis", sci:"Bos taurus", note:"ç‰›è†½å›Šä¸­çš„çµçŸ³"},
        {tags:["å¤§äºŒä¸Š"], name:"é‡‘éŠ€èŠ±", family:"Caprifoliaceae", drug:"Lonicerae Flos", sci:"Lonicera japonica", note:"å¿å†¬-å‡Œå†¬ä¸å‡‹"},
        {tags:["å¤§äºŒä¸Š"], name:"æ´‹é‡‘èŠ±", family:"Solanaceae", drug:"Daturae Flos", sci:"Datura metel", note:"éº»æ²¸æ•£ã€Tropane alkaloids"},
        {tags:["å¤§äºŒä¸Š"], name:"ç›Šæ¯è‰", family:"Lamiaceae", drug:"Leonuri Herba", sci:"Leonurus heterophyllus", note:"å……è”š(æœå¯¦)"},
        {tags:["å¤§äºŒä¸Š"], name:"é­šè…¥è‰", family:"Saururaceae", drug:"Houttuyniae Herba", sci:"Houttuynia cordata", note:"è•ºèœ"},
        {tags:["å¤§äºŒä¸Š"], name:"éº»é»ƒ", family:"Ephedraceae", drug:"Ephedrae Herba", sci:"Ephedra sinica", note:"å« Ephedrine(æ”¯æ°£ç®¡æ“´å¼µ)ã€è£¸å­æ¤ç‰©"},
        {tags:["å¤§äºŒä¸Š"], name:"å…«è§’èŒ´é¦™", family:"Magnoliaceae", drug:"Anisi Stellati Fructus", sci:"Illicium verum", note:"å« Anetholeã€æ®ç™¼æ²¹"},
        {tags:["å¤§äºŒä¸Š"], name:"æ±ºæ˜å­", family:"Fabaceae", drug:"Cassiae Semen", sci:"Cassia obtusifolia", note:"å­å½¢ä¼¼é¦¬è¹„"},
        {tags:["å¤§äºŒä¸Š"], name:"è»Šå‰è‰", family:"Plantaginaceae", drug:"Plantaginis Herba", sci:"Plantago asiatica", note:"æœ‰ç€‰ä¸‹åŠŸç”¨"},
        {tags:["å¤§äºŒä¸Š"], name:"èƒ¡æ¤’", family:"Piperaceae", drug:"Piperis Nigri Fructus", sci:"Piper nigrum", note:"èƒ¡æ¤’æœ"},
        {tags:["å¤§äºŒä¸Š"], name:"è›‡åºŠå­", family:"Apiaceae", drug:"Cnidii Fructus", sci:"Cnidium monnieri", note:"æ²»é™½ç—¿ã€å®®å†·ä¸å­•ã€é€£é™½å…«åº§"},
        {tags:["å¤§äºŒä¸Š"], name:"æª³æ¦”å­", family:"Arecaceae", drug:"Arecae Semen", sci:"Areca catechu", note:"å« Arecoline (æª³æ¦”é¹¼)"},
        {tags:["å¤§äºŒä¸Š"], name:"æœä»²", family:"Eucommiaceae", drug:"Eucommiae Cortex", sci:"Eucommia ulmoides", note:"æ²’æœ‰ç€‰ä¸‹ã€æŠ˜æ–·æœ‰çµ²ã€ä¸€ç§‘ä¸€å±¬ã€é›Œé›„ç•°æ ªã€æ¨¹çš®å¼·å£¯è—¥"},
        {tags:["å¤§äºŒä¸Š"], name:"åšæœ´", family:"Magnoliaceae", drug:"Magnoliae Cortex", sci:"Magnolia officinalis", note:"è—¥ç”¨è–çš®"},
        {tags:["å¤§äºŒä¸Š"], name:"è‚‰æ¡‚", family:"Lauraceae", drug:"Cinnamomi Cortex", sci:"Cinnamomum cassia", note:"å« Cinnamaldehyde"},
        {tags:["å¤§äºŒä¸Š"], name:"é»ƒæŸ", family:"Rutaceae", drug:"Phellodendri Cortex", sci:"Phellodendron amurense", note:"å« Berberineã€è‹¦å‘³å¥èƒƒ"},

        // --- é€™è£¡å¯ä»¥éš¨æ™‚æ–°å¢å¤§äºŒä¸‹çš„è³‡æ–™ï¼Œä¾‹å¦‚ï¼š ---
        // {tags:["å¤§äºŒä¸‹"], name:"äººåƒ", family:"Araliaceae", drug:"Ginseng Radix", sci:"Panax ginseng", note:"å¤§è£œå…ƒæ°£"}
    ];

    let currentMode = 'mix';
    let score = 0, count = 0;
    let canAnswer = true;
    let wrongLog = [];
    let currentQData = {};
    let weights = { family: 1, drug: 1, sci: 1, note: 1 };
    
    // é€™æ˜¯ç›®å‰ã€Œè¢«é¸ä¸­ã€è¦è€ƒè©¦çš„é¡Œç›®ç´¢å¼•æ± 
    let activeIndices = []; 
    // é€™æ˜¯åœ°æ¯¯å¼è¤‡ç¿’ç”¨çš„æš«å­˜æ± 
    let questionPool = [];
    let sessionWrongIndices = [];

    // --- åˆå§‹åŒ– checkbox ---
    function initCheckboxes() {
        const area = document.getElementById('custom-checkboxes');
        area.innerHTML = "";
        db.forEach((item, index) => {
            const label = document.createElement('label');
            label.className = 'checkbox-item';
            label.innerHTML = `<input type="checkbox" value="${index}" checked> ${item.name}`;
            area.appendChild(label);
        });
    }

    // --- ç¯„åœé¸æ“‡é‚è¼¯ ---
    function selectRange(tag, btn) {
        // 1. åˆ‡æ›æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('custom-checkboxes').style.display = 'none';

        // 2. è‡ªå‹•å‹¾é¸å°æ‡‰çš„ checkbox
        const checkboxes = document.querySelectorAll('#custom-checkboxes input');
        checkboxes.forEach(box => {
            const idx = parseInt(box.value);
            if (tag === 'all') {
                box.checked = true;
            } else {
                // æª¢æŸ¥è©²è—¥æçš„ tags æ˜¯å¦åŒ…å«é¸ä¸­çš„ tag
                const item = db[idx];
                if (item.tags && item.tags.includes(tag)) {
                    box.checked = true;
                } else {
                    box.checked = false;
                }
            }
        });
    }

    function toggleCustom(btn) {
        document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const area = document.getElementById('custom-checkboxes');
        area.style.display = (area.style.display === 'block') ? 'none' : 'block';
    }

    // --- é–‹å§‹æ¸¬é©—ï¼šå»ºç«‹é¡Œåº« ---
    function startQuiz() {
        // 1. æ”¶é›†è¢«å‹¾é¸çš„é¡Œç›®ç´¢å¼•
        activeIndices = [];
        document.querySelectorAll('#custom-checkboxes input:checked').forEach(box => {
            activeIndices.push(parseInt(box.value));
        });

        if (activeIndices.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è—¥æï¼");
            return;
        }

        // 2. åˆ‡æ›ç•«é¢
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('quiz-container').style.display = 'block';

        // 3. åˆå§‹åŒ–ç‹€æ…‹
        score = 0; count = 0; wrongLog = []; sessionWrongIndices = [];
        document.getElementById('score').innerText = 0;
        document.getElementById('count').innerText = 0;

        // 4. å¡«å……åœ°æ¯¯å¼é¡Œåº« (åªåŒ…å«é¸ä¸­çš„)
        questionPool = [...activeIndices];
        updatePoolInfo();
        
        // 5. è®€å–æ¬Šé‡ä¸¦å‡ºé¡Œ
        initWeights();
        nextQuestion();
    }

    // --- å›é¦–é  ---
    function goHome() {
        document.getElementById('review-section').style.display = 'none';
        document.getElementById('quiz-container').style.display = 'none';
        document.getElementById('setup-screen').style.display = 'block';
    }

    // --- æ›´æ–°é¡Œåº«è³‡è¨Šé¡¯ç¤º ---
    function updatePoolInfo() {
        const strategy = document.querySelector('input[name="strategy"]:checked').value;
        const info = document.getElementById('pool-info');
        if (strategy === 'once') {
            if (questionPool.length === 0 && count === 0) questionPool = [...activeIndices];
            info.innerText = `ç¯„åœå‰©é¤˜ï¼š${questionPool.length} / ${activeIndices.length}`;
        } else {
            info.innerText = `éš¨æ©Ÿæ¨¡å¼ (ç¯„åœå…± ${activeIndices.length} é¡Œ)`;
        }
    }

    // --- æ¬Šé‡èˆ‡å‡ºé¡Œé‚è¼¯ (éƒ¨åˆ†æ²¿ç”¨) ---
    function initWeights() {
        try {
            let saved = localStorage.getItem('quizWeights');
            if (saved) weights = JSON.parse(saved);
        } catch (e) {}
        updateWeightDisplay();
    }
    function saveWeights() {
        try { localStorage.setItem('quizWeights', JSON.stringify(weights)); } catch (e) {}
        updateWeightDisplay();
    }
    function updateWeightDisplay() {
        document.getElementById('w-family').innerText = weights.family;
        document.getElementById('w-drug').innerText = weights.drug;
        document.getElementById('w-sci').innerText = weights.sci;
        document.getElementById('w-note').innerText = weights.note;
    }

    function setMode(mode, btn) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // åˆ‡æ›æ¨¡å¼æ™‚ï¼Œå¦‚æœæ˜¯åœ°æ¯¯å¼ï¼Œéœ€è¦é‡ç½®è©²è¼ª
        if(document.querySelector('input[name="strategy"]:checked').value === 'once'){
             questionPool = [...activeIndices]; // é‡è£œæ»¿
             updatePoolInfo();
        }
        nextQuestion();
    }

    function getWeightedType() {
        let totalWeight = weights.family + weights.drug + weights.sci + weights.note;
        let randomNum = Math.random() * totalWeight;
        if (randomNum < weights.family) return 'family';
        randomNum -= weights.family;
        if (randomNum < weights.drug) return 'drug';
        randomNum -= weights.drug;
        if (randomNum < weights.sci) return 'sci';
        return 'note';
    }

    function nextQuestion() {
        canAnswer = true;
        document.getElementById('next-btn').style.display = 'none';
        
        const strategy = document.querySelector('input[name="strategy"]:checked').value;
        let dbIndex; // åœ¨ db ä¸­çš„çœŸå¯¦ç´¢å¼•

        if (strategy === 'once') {
            if (questionPool.length === 0) {
                alert("æ­å–œï¼é¸å®šç¯„åœçš„é¡Œç›®å·²å…¨éƒ¨ç·´ç¿’å®Œç•¢ï¼");
                endQuiz();
                return;
            }
            let randIdx = Math.floor(Math.random() * questionPool.length);
            dbIndex = questionPool[randIdx];
            questionPool.splice(randIdx, 1);
            updatePoolInfo();
        } else {
            // å¾ activeIndices éš¨æ©ŸæŠ½
            let randIdx = Math.floor(Math.random() * activeIndices.length);
            dbIndex = activeIndices[randIdx];
            updatePoolInfo();
        }

        currentQData.dbIndex = dbIndex; // è¨˜ä½é€™é¡Œæ˜¯èª°
        const item = db[dbIndex];
        let type = currentMode;
        if (type === 'mix') type = getWeightedType();

        let qText = "", tagText = "";
        let correctAns = item[type];
        if (!correctAns) { type = 'family'; correctAns = item.family; }

        switch(type) {
            case 'family': qText = `ã€${item.name}ã€‘ å±¬æ–¼å“ªä¸€ç§‘ï¼Ÿ`; tagText = "ğŸŒ± è€ƒç§‘å"; break;
            case 'drug':   qText = `ã€${item.name}ã€‘ çš„ç”Ÿè—¥å (Latin) æ˜¯ï¼Ÿ`; tagText = "ğŸ’Š è€ƒç”Ÿè—¥å"; break;
            case 'sci':    qText = `ã€${item.name}ã€‘ çš„å­¸å (Scientific) æ˜¯ï¼Ÿ`; tagText = "ğŸ”¬ è€ƒå­¸å"; break;
            case 'note':   qText = `é—œæ–¼ã€${item.name}ã€‘ çš„ç‰¹å¾µ/å‚™è¨»ï¼Œä½•è€…æ­£ç¢ºï¼Ÿ`; tagText = "ğŸ“ è€ƒç‰¹å¾µ"; break;
        }

        currentQData.type = type;
        currentQData.question = qText;
        currentQData.correct = correctAns;
        
        document.getElementById('q-tag').innerText = tagText;
        document.getElementById('question').innerText = qText;

        // ç”¢ç”Ÿé¸é … (å¹²æ“¾é …ä¹Ÿè¦å¾ activeIndices è£¡é¢æŠ“æ¯”è¼ƒåˆç†ï¼Œæˆ–è€…æ˜¯å¾å…¨ db æŠ“éƒ½å¯ä»¥ï¼Œé€™è£¡å¾å…¨ db æŠ“å¢åŠ é›£åº¦)
        let options = [correctAns];
        let safetyLoop = 0;
        while(options.length < 4 && safetyLoop < 50) {
            let randomDbIdx = Math.floor(Math.random() * db.length);
            let randomItem = db[randomDbIdx];
            let otherAns = randomItem[type];
            if(otherAns && !options.includes(otherAns)) options.push(otherAns);
            safetyLoop++;
        }
        options.sort(() => Math.random() - 0.5);

        const area = document.getElementById('options-area');
        area.innerHTML = "";
        options.forEach(opt => {
            let btn = document.createElement("button");
            btn.className = "opt-btn";
            btn.innerText = opt;
            btn.onclick = function() { checkAnswer(this, opt, correctAns); };
            area.appendChild(btn);
        });
    }

    function checkAnswer(btn, myAns, correctAns) {
        if(!canAnswer) return;
        canAnswer = false;
        count++;
        
        const allBtns = document.querySelectorAll('.opt-btn');
        if (myAns === correctAns) {
            btn.classList.add('correct');
            score++;
        } else {
            btn.classList.add('wrong');
            allBtns.forEach(b => { if(b.innerText === correctAns) b.classList.add('correct'); });
            
            wrongLog.push({ q: currentQData.question, wrong: myAns, right: correctAns });
            if (!sessionWrongIndices.includes(currentQData.dbIndex)) {
                sessionWrongIndices.push(currentQData.dbIndex);
            }
            
            weights[currentQData.type] += 1;
            saveWeights();
        }
        
        document.getElementById('score').innerText = score;
        document.getElementById('count').innerText = count;
        document.getElementById('next-btn').style.display = 'inline-block';
    }

    function endQuiz() {
        document.getElementById('quiz-container').style.display = 'none';
        document.getElementById('review-section').style.display = 'block';
        document.getElementById('final-score').innerText = `${score} / ${count}`;
        
        const reviewBtn = document.getElementById('review-wrong-btn');
        if (sessionWrongIndices.length > 0) {
            reviewBtn.style.display = 'block';
            reviewBtn.innerText = `ğŸ¯ ç«‹å³è¤‡ç¿’æœ¬è¼ªéŒ¯é¡Œ (${sessionWrongIndices.length} é¡Œ)`;
        } else {
            reviewBtn.style.display = 'none';
        }

        const list = document.getElementById('wrong-list');
        list.innerHTML = "";
        if(wrongLog.length === 0) {
            list.innerHTML = "<p style='text-align:center; color:#2e7d32;'>ğŸ‰ å¤ªå¼·äº†ï¼é€™è¼ªå…¨å°ï¼</p>";
        } else {
            wrongLog.forEach((item, index) => {
                let div = document.createElement('div');
                div.className = 'review-item';
                div.innerHTML = `<div class="review-q">${index+1}. ${item.q}</div><div class="review-wrong">âŒ ä½ çš„å›ç­”ï¼š${item.wrong}</div><div class="review-correct">âœ… æ­£ç¢ºç­”æ¡ˆï¼š${item.right}</div>`;
                list.appendChild(div);
            });
        }
    }

    function startReviewWrong() {
        // è¨­å®šã€Œä½œç”¨ä¸­ã€çš„é¡Œç›®ç‚ºå‰›å‰›éŒ¯çš„é‚£äº›
        activeIndices = [...sessionWrongIndices];
        
        // å¼·åˆ¶åˆ‡æ›åˆ°åœ°æ¯¯æ¨¡å¼
        const radios = document.getElementsByName('strategy');
        radios.forEach(r => { if(r.value === 'once') r.checked = true; });
        
        // åˆ‡æ›ç•«é¢å›å»
        document.getElementById('review-section').style.display = 'none';
        document.getElementById('quiz-container').style.display = 'block';
        
        // é‡ç½®åˆ†æ•¸èˆ‡æš«å­˜æ± 
        score = 0; count = 0; wrongLog = [];
        document.getElementById('score').innerText = 0;
        document.getElementById('count').innerText = 0;
        
        questionPool = [...activeIndices];
        updatePoolInfo();
        nextQuestion();
    }

    // åˆå§‹åŒ–åŸ·è¡Œ
    initCheckboxes();
</script>
</body>
</html>
